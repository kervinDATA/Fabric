************** DW001 *************************


***** Création de schema
CREATE SCHEMA raw;
CREATE SCHEMA transformed;
CREATE SCHEMA analytics;

GO


***** Création tables
CREATE TABLE raw.hubspot_contacts (
      customer_id INT
    , customer_name VARCHAR(100)
    , customer_city_id INT
    , customer_email VARCHAR(100)
);

CREATE TABLE raw.hubspot_locations_lookup (
      customer_country_id INT
    , customer_city_id INT
    , customer_country_name VARCHAR(100)
    , customer_city_name VARCHAR(100)
);




************** DW002 *************************
ADDING NEW DATA TO TABLES

*** manually : 
INSERT INTO raw.hubspot_locations_lookup  
VALUES 
      (40001, 1001, 'France', 'Bordeaux')
    , (40001, 1001, 'France', 'Paris')
    , (40002, 1001, 'Germany', 'Munich')
    , (40002, 1001, 'Germany', 'Berlin')
    ; 


SELECT TOP (100) [customer_country_id],
			[customer_city_id],
			[customer_country_name],
			[customer_city_name]
FROM [DW001_DWH].[raw].[hubspot_locations_lookup]


-------------
-- Copier fichiers Parquet et csv : COPY INTO
-- To load data from a CSV file skipping a header row

COPY INTO raw.hubspot_contacts
FROM 'https://dojostorage.blob.core.windows.net/dojostorage/hubspot_contacts_test.csv'
WITH (
      FILE_TYPE = 'CSV'
    , FIRSTROW = 2
);




************** DW011 *************************


Difference Between DROP, DELETE and TRUNCATE
DROP and TRUNCATE are DDL command while DELETE is a DML command. 

*
DELETE remove the specific row based on the given condition, 
*
TRUNCATE removes all the record from the table at once,
*
DROP command removes the table or databases and as well as the structure.



*************** DW013  STORED PROCEDURE ***************************

-- DW013_01
CREATE PROCEDURE raw.p_get_all_contacts
AS
BEGIN
SELECT 
      [customer_id]
    , [customer_name]
    , [customer_city_id]
    , [customer_email]
FROM raw.hubspot_contacts
END


EXEC raw.p_get_all_contacts




-- DW013_02
CREATE PROCEDURE raw.p_get_filtered_contacts
@customer_city_id  int
AS
BEGIN
SELECT 
      [customer_id]
    , [customer_name]
    , [customer_city_id]
    , [customer_email]
FROM raw.hubspot_contacts
WHERE customer_city_id = @customer_city_id
END


EXEC raw.p_get_filtered_contacts @customer_city_id = 1004




-- DW013_03 INSERT
CREATE PROCEDURE raw.p_insert_new_location
  @customer_country_id INT
, @customer_city_id INT
, @customer_country_name VARCHAR(100)
, @customer_city_name VARCHAR(100)
AS
BEGIN
INSERT INTO raw.hubspot_locations_lookup
VALUES (@customer_country_id, @customer_city_id, @customer_country_name, @customer_city_name)
END



EXEC raw.p_insert_new_location
@customer_country_id = 4005
, @customer_city_id = 1010
, @customer_country_name = 'United Kingdom'
, @customer_city_name = 'Birmingham'




SELECT * FROM raw.hubspot_locations_lookup;




-- DW013_04 UPDATE
CREATE PROCEDURE raw.p_update_location_name
  @CityID INT
, @NewCityName VARCHAR(100)
AS
BEGIN
UPDATE raw.hubspot_locations_lookup
SET customer_city_name = @NewCityName
WHERE customer_city_id = @CityID
END



EXEC raw.p_update_location_name
@CityID = 1010,
@NewCityName = 'Leeds'


SELECT * FROM raw.hubspot_locations_lookup;



 ************** DW014  IF/ ELSE logic ********************************************

-- DW014  IF/ ELSE logic

CREATE PROCEDURE raw.p_merge_customer_locations
  @customer_country_id  INT
, @customer_city_id  INT
, @customer_country_name VARCHAR(100)
, @customer_city_name VARCHAR(100)
AS
IF EXISTS (SELECT 1 FROM raw.hubspot_locations_lookup WHERE customer_city_id = @customer_city_id)
BEGIN
UPDATE raw.hubspot_locations_lookup
SET   customer_country_id = @customer_country_id
    , customer_country_name = @customer_country_name
    , customer_city_name = @customer_city_name
WHERE customer_city_id = @customer_city_id;
END

ELSE

BEGIN
INSERT INTO raw.hubspot_locations_lookup (customer_country_id, customer_city_id, customer_country_name, customer_city_name)
VALUES (@customer_country_id, @customer_city_id, @customer_country_name, @customer_city_name);
END




EXEC raw.p_merge_customer_locations
@customer_country_id = 4005 , 
@customer_city_id = 1010 , 
@customer_country_name = 'United Kingdom', 
@customer_city_name = 'Bristol' 



SELECT * FROM raw.hubspot_locations_lookup;




EXEC raw.p_merge_customer_locations
@customer_country_id = 4006, 
@customer_city_id = 1011 , 
@customer_country_name = 'Netherlands', 
@customer_city_name = 'Amsterdam'


*****************************************************






